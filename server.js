const express = require('express');
const { Client } = require('pg');
const path = require('path');

const app = express();
const PORT = process.env.PORT || 10000;

// Ð’Ð°ÑˆÐ° ÑÑ‚Ñ€Ð¾ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
const connectionString = 'postgresql://message_db_svae_user:rHkEJRmOfJeBjrmbwtHGMXVZ3EO6Ass0@dpg-d63gou4hg0os73cfsc00-a.frankfurt-postgres.render.com:5432/message_db_svae';

console.log('Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°...');

// Middleware
app.use(express.json());
app.use(express.static('public'));

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ð‘Ð”
const createConnection = () => {
  return new Client({
    connectionString: connectionString,
    ssl: {
      rejectUnauthorized: false,
      require: true
    }
  });
};

// Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
let dbClient = null;

// ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð‘Ð”
const connectToDB = async () => {
  try {
    dbClient = createConnection();
    await dbClient.connect();
    console.log('âœ… ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ Ðº PostgreSQL');
    
    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
    await dbClient.query(`
      CREATE TABLE IF NOT EXISTS messages (
        id SERIAL PRIMARY KEY,
        text TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      )
    `);
    console.log('âœ… Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° messages Ð³Ð¾Ñ‚Ð¾Ð²Ð°');
    
    return true;
  } catch (error) {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ð‘Ð”:', error.message);
    dbClient = null;
    return false;
  }
};

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
const handleDBQuery = async (query, params) => {
  if (!dbClient) {
    const connected = await connectToDB();
    if (!connected) {
      throw new Error('ÐÐµÑ‚ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ð‘Ð”');
    }
  }
  
  try {
    return await dbClient.query(query, params);
  } catch (error) {
    // Ð•ÑÐ»Ð¸ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ñ‚ÐµÑ€ÑÐ½Ð¾, Ð¿Ñ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¿ÐµÑ€ÐµÐ¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ
    if (error.code === 'ECONNREFUSED' || error.message.includes('connection')) {
      console.log('ÐŸÐµÑ€ÐµÐ¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð‘Ð”...');
      const connected = await connectToDB();
      if (connected) {
        return await dbClient.query(query, params);
      }
    }
    throw error;
  }
};

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ðµ
connectToDB();

// ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹
app.get('/api/health', (req, res) => {
  res.json({ 
    status: 'ok',
    timestamp: new Date().toISOString(),
    database: dbClient ? 'connected' : 'disconnected'
  });
});

app.get('/api/db-check', async (req, res) => {
  try {
    const result = await handleDBQuery('SELECT NOW()');
    res.json({ 
      success: true, 
      message: 'Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°',
      time: result.rows[0].now
    });
  } catch (error) {
    res.status(500).json({ 
      error: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ð‘Ð”',
      details: error.message 
    });
  }
});

// Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐºÑÑ‚Ð° - Ð¡Ð˜ÐÐ¥Ð ÐžÐÐÐÐ¯ Ð²ÐµÑ€ÑÐ¸Ñ
app.post('/api/save', async (req, res) => {
  console.log('ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ');
  
  try {
    const { text } = req.body;
    
    if (!text || text.trim() === '') {
      return res.status(400).json({ error: 'Ð¢ÐµÐºÑÑ‚ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼' });
    }

    console.log('Ð¢ÐµÐºÑÑ‚ Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ:', text.substring(0, 50) + '...');

    // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ
    const result = await handleDBQuery(
      'INSERT INTO messages (text) VALUES ($1) RETURNING id, created_at',
      [text]
    );

    console.log('âœ… Ð¢ÐµÐºÑÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½, ID:', result.rows[0].id);

    res.json({ 
      success: true, 
      message: 'Ð¢ÐµÐºÑÑ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½!',
      id: result.rows[0].id,
      created_at: result.rows[0].created_at
    });
  } catch (error) {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ:', error.message);
    
    res.status(500).json({ 
      error: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°',
      details: error.message,
      code: error.code
    });
  }
});

// ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð²ÑÐµÑ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
app.get('/api/messages', async (req, res) => {
  try {
    const result = await handleDBQuery(
      'SELECT * FROM messages ORDER BY created_at DESC LIMIT 100'
    );
    res.json(result.rows);
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹:', error);
    res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…' });
  }
});

// Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°
app.get('/api/stats', async (req, res) => {
  try {
    const result = await handleDBQuery('SELECT COUNT(*) FROM messages');
    res.json({ count: parseInt(result.rows[0].count) });
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸:', error);
    res.status(500).json({ error: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸' });
  }
});

// ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ HTML
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

app.listen(PORT, () => {
  console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);
});
